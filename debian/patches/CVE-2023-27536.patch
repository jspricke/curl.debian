From cb49e67303dbafbab1cebf4086e3ec15b7d56ee5 Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Fri, 10 Mar 2023 09:22:43 +0100
Subject: [PATCH] url: only reuse connections with same GSS delegation

Reported-by: Harry Sintonen
Closes #10731

Backported to Debian by Samuel Henrique <samueloph@debian.org>
---
 lib/url.c     | 6 ++++++
 lib/urldata.h | 1 +
 2 files changed, 7 insertions(+)

Index: curl/lib/url.c
===================================================================
--- curl.orig/lib/url.c
+++ curl/lib/url.c
@@ -1218,6 +1218,11 @@ ConnectionExists(struct Curl_easy *data,
         continue;
 #endif
 
+      /* GSS delegation differences do not actually affect every connection
+         and auth method, but this check takes precaution before efficiency */
+      if(needle->gssapi_delegation != check->gssapi_delegation)
+        continue;
+
 #ifndef CURL_DISABLE_FTP
       if(get_protocol_family(needle->handler) & PROTO_FAMILY_FTP) {
         /* Also match ACCOUNT, ALTERNATIVE-TO-USER, USE_SSL and CCC options */
@@ -1971,6 +1976,7 @@ static struct connectdata *allocate_conn
      it may live on without (this specific) Curl_easy */
   conn->fclosesocket = data->set.fclosesocket;
   conn->closesocket_client = data->set.closesocket_client;
+  conn->gssapi_delegation = data->set.gssapi_delegation;
 
   return conn;
   error:
Index: curl/lib/urldata.h
===================================================================
--- curl.orig/lib/urldata.h
+++ curl/lib/urldata.h
@@ -920,6 +920,7 @@ struct connectdata {
   const struct Curl_handler *given;   /* The protocol first given */
 
   long ip_version; /* copied from the Curl_easy at creation time */
+  unsigned char gssapi_delegation; /* inherited from set.gssapi_delegation */
 
   /* Protocols can use a custom keepalive mechanism to keep connections alive.
      This allows those protocols to track the last time the keepalive mechanism
